<script>
  function processResults (value) {
    var currentMatch;
    var alliance;
    var effectiveAllianceColor; //the color the card representing this match should be; if the match already has a score, then this won't be the same as this team's color in the match
    var alliancePosition;
    var partner;
    var opponents;
    var detailsURL;
    var winningAlliance; //the alliance, if any (e.g., if there was a tie), that won the match
    var matchResult; //whether this team won, lost, or tied this match
    
    //variables that need to be reset to their original values each iteration
    var matchDone = false;
    var matchResultsString = "";
    var scoresString = "";
    var scoreAvailable = false;
    
    $('#match-container').empty(); //this is actually the second emptying of this div; this time, we're removing the loading indication now that the match data has loaded and just needs to be processed
    
    console.log(value);
    for (var i = 0; i < value.results.length; i++) {
      currentMatch = value.results[i];
      console.log("currentMatch.red1 = " + currentMatch.red1 + "; team = " + queryTeam);
      //determine alliance and position on alliance
      
       if (currentMatch.red1 === queryTeam) {
          console.log("red1 matches");
          alliance = "red-alliance";
          alliancePosition = "red1";
       } else if (currentMatch.red2 === queryTeam) {
          alliance = "red-alliance";
          alliancePosition = "red2";
       } else if (currentMatch.blue1 === queryTeam) {
          alliance = "blue-alliance";
          alliancePosition = "blue1";
       } else if (currentMatch.blue2 === queryTeam) {
          alliance = "blue-alliance";
          alliancePosition = "blue2";
       }
     
       if (currentMatch.bluescore !== "" && currentMatch.redscore !== "") {
         scoreAvailable = true;
         effectiveAllianceColor = "match-done";
       } else {
         effectiveAllianceColor = alliance;
       }
      //determine partner for this match
      if (alliance === "red-alliance") {
        if (alliancePosition === "red1") {
          partner = currentMatch.red2;
        } else { //this team is red2, so partner is red1
          partner = currentMatch.red1;
        }
      } else if (alliance === "blue-alliance") {
        if (alliancePosition === "blue1") {
          partner = currentMatch.blue2;
        } else { //this team is blue2, so partner is blue1
          partner = currentMatch.blue1;
        }
      }
      
      //determine and construct a string containing both teams in the opposing alliance
      if (alliance === "red-alliance") {
        opponents = currentMatch.blue1 + "/" + currentMatch.blue2;
      } else {
        opponents = currentMatch.red1 + "/" + currentMatch.red2;
      }
      
      //output the match result if available
      if (scoreAvailable) {
        //determine which alliance won
        if (currentMatch.redscore > currentMatch.bluescore) {
          winningAlliance = "red-alliance";
          scoresString = '<span class="red-alliance-text">' + currentMatch.redscore + '</span>-<span class="blue-alliance-text">' + currentMatch.bluescore + '</span>'; //higher score always goes first
        } else if (currentMatch.redscore < currentMatch.bluescore) {
          winningAlliance = "blue-alliance";
          scoresString = '<span class="blue-alliance-text">' + currentMatch.bluescore + '</span>-<span class="red-alliance-text">' + currentMatch.redscore + '</span>'; //higher score always goes first
        } else { //tie
          winningAlliance = "tie";
          scoresString = '<span class="red-alliance-text">' + currentMatch.redscore + '</span>-<span class="blue-alliance-text">' + currentMatch.bluescore + '</span>'; //the order doesn't really matter, so put red alliance first
        }
        console.log(winningAlliance);
        
        if (alliance === winningAlliance) {
        matchResult = "won";
        } else if (winningAlliance === "tie") {
        matchResult = "tied";
        } else {
        matchResult = "lost";
        }
        
        if (winningAlliance === "tie") {
          matchResultsString = '<strong>You '+ matchResult + '</strong> ' + scoresString  + '<br />';
        } else {
          matchResultsString = '<span class="' + alliance + '-text"><strong>You '+ matchResult + '</strong></span> ' + scoresString + '<br />';
        }
      }
      
      //for now, the first part of this URL will be hard-coded; in the future there will need to be a method to keep track of what users are using what WARS instances
      detailsURL = "https://script.google.com/a/macros/woodward.edu/s/AKfycbzjo4-KCrLdrFOcpJCwg3kwWYenjFyV8C6aAxfVZs4/exec?page=match&match=" + currentMatch.matchnumber;
      
      
      var matchInfo = '<div class="mdl-cell--2-col mdl-cell--3-col-tablet mdl-cell--3-col-desktop"><div class="match-info-card mdl-card mdl-shadow--2dp ' + effectiveAllianceColor + '"><div class="mdl-card__title"><h4 id="match-num">Q'
                        + value.results[i].matchnumber + '</h4></div><div class="mdl-card__supporting-text">' + matchResultsString + '<em>With</em> ' + partner + '<br /><em>Against</em> ' + opponents + '</div><div class="mdl-card__actions mdl-card--border"><a href="' 
                        + detailsURL + '" class="mdl-button mdl-button--colored mdl-js-button mdl-js-ripple-effect">Details</a><div class="mdl-layout-spacer"></div><i class="material-icons">info_outline</i></div></div></div>'
      console.log(matchInfo);
      
      $('#match-container').append(matchInfo); 
      
      //reset variables
      matchDone = false;
      matchResultsString = "";
      scoreAvailable = false;
      scoresString = "";
    }
  }
  
  function getTeamMatches(queryTeam) {
    var url="https://script.google.com/a/macros/woodward.edu/s/AKfycbxsKMe0cdyYScaJXipBoA2bFSY8Aj-jxlQqyS4aDOI/exec?prefix=processResults&type=getTeamMatches&id=1vrZQpvtiJvcyKdlULZk5HOyRU5ystAiMZ4y8rF6dJEg&team=" + queryTeam;
    if (userTeam !== queryTeam) {
      if ($('#show-diff-team').hasClass('hidden')) { //only remove the hidden class if it's present
        $('#show-diff-team').removeClass('hidden');
      }
    } else if (!$('#show-diff-team').hasClass('hidden')) { //only add the hidden class if it's absent
        $('#show-diff-team').addClass('hidden');
    }
    console.log(url);
    $('body').append('<script id="api-request" src="' + url + '"><\/script>');
  }
  
  var selector = '[value="' + queryTeam + '"]';
  $(selector).attr("selected","selected");
  $('#team-select').change(function() {
    $('#match-container').empty() //remove the current set of matches being displayed from the page before displaying the new matches (if any); this is located here to prevent confusion of two sets of matches while the new set is loading
                         .prepend('<div class="mdl-cell--12-col"> <em>Loading...</em></div>');
    $('#api-request').remove(); //get rid of the original API call to prevent build-up of old script tags
    queryTeam = $('#team-select').val()
    getTeamMatches(queryTeam);
  });
  console.log(queryTeam);
  console.log(userTeam);
  getTeamMatches(queryTeam);
</script>
